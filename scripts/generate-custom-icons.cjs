const fs = require("node:fs")
const path = require("node:path")

const ROOT = path.resolve(__dirname, "..")
const ICONS_DIR = path.join(ROOT, "src/app/components/custom-icons")
const OUT_FILE = path.join(ICONS_DIR, "generated.tsx")
const WATCH = process.argv.includes("--watch")

function pascalCase(str) {
  return str
    .replace(/(^|[^a-zA-Z0-9]+)([a-zA-Z0-9])/g, (_, __, c) => c.toUpperCase())
    .replace(/[^a-zA-Z0-9]/g, "")
}

function componentNameFromFile(file) {
  // icon.16.arrow-down.svg -> IconArrowDown16
  const base = path.basename(file, ".svg")
  const parts = base.split(".") // ["icon","16","arrow-down"] or ["icon","16","chevron","down"]
  const size = parts.find((p) => /^\d+$/.test(p)) ?? "16"
  const rest = parts.filter((p) => p !== "icon" && p !== size).join("-")
  const name = pascalCase(rest)
  return `Icon${name}${size}`
}

function extractPaths(svgText) {
  const pathTags = svgText.match(/<path\b[^>]*\/?>/g) ?? []
  if (pathTags.length === 0) return []
  return pathTags.map((tag) => {
    const d = (tag.match(/\bd="([^"]+)"/) ?? [])[1]
    const fillOpacity = (tag.match(/\bfill-opacity="([^"]+)"/) ?? [])[1]
    if (!d) {
      throw new Error(`Missing path d="" in: ${tag}`)
    }
    return { d, fillOpacity: fillOpacity ?? null }
  })
}

function generate() {
  const files = fs
    .readdirSync(ICONS_DIR)
    .filter((f) => f.endsWith(".svg"))
    .sort()

  const bodies = []

  for (const file of files) {
    const abs = path.join(ICONS_DIR, file)
    const text = fs.readFileSync(abs, "utf8")
    const paths = extractPaths(text)
    const comp = componentNameFromFile(file)

    const pathJsx = paths
      .map((p) => {
        const opacityExpr = p.fillOpacity ? `{props.opacity ?? ${Number(p.fillOpacity)}}` : "{props.opacity ?? 0.9}"
        return `      <path d="${p.d}" fill={color} fillOpacity=${opacityExpr} />`
      })
      .join("\n")

    bodies.push(
      `export function ${comp}(props: SvgProps) {
  const color = props.color ?? "currentColor"
  return (
    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-label={props.title}>
${pathJsx}
    </svg>
  )
}`
    )
  }

  const out = `// This file is auto-generated by scripts/generate-custom-icons.cjs
// Do not edit manually. Edit the .svg files in this folder instead.

import { h } from "preact"

export type SvgProps = {
  color?: string
  opacity?: number
  title?: string
}

${bodies.join("\n\n")}
`

  fs.writeFileSync(OUT_FILE, out, "utf8")
  return { count: files.length, outFile: OUT_FILE }
}

try {
  const res = generate()
  // eslint-disable-next-line no-console
  console.log(`[icons] Generated ${res.count} icons -> ${path.relative(ROOT, res.outFile)}`)

  if (WATCH) {
    // eslint-disable-next-line no-console
    console.log("[icons] Watching for SVG changesâ€¦")
    fs.watch(ICONS_DIR, { persistent: true }, (eventType, filename) => {
      if (!filename || !filename.endsWith(".svg")) return
      try {
        const r = generate()
        // eslint-disable-next-line no-console
        console.log(`[icons] Regenerated (${eventType} ${filename}) -> ${path.relative(ROOT, r.outFile)}`)
      } catch (err) {
        // eslint-disable-next-line no-console
        console.error("[icons] Regenerate failed:", err)
      }
    })
    // Keep process alive
    setInterval(() => {}, 1 << 30)
  }
} catch (e) {
  // eslint-disable-next-line no-console
  console.error("[icons] Failed to generate icons:", e)
  process.exit(1)
}

